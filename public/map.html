<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title></title>
		<link
			rel="stylesheet"
			href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
			integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
			crossorigin=""
		/>
		<link
			rel="stylesheet"
			href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
			integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p"
			crossorigin="anonymous"
		/>
		<link rel="stylesheet" href="/css/main.css" />

		<script
			src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
			integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
			crossorigin=""
		></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.26.0/moment-with-locales.min.js"></script>

		<style>
			body {
				margin: 0;
			}
			.rain-map-time-wrapper {
				position: absolute;
				top: 10px;
				background: #ccc;
				padding: 0 10px 0 10px;
				z-index: 999;
				opacity: 0.75;
				font-weight: bold;
				color: #000;
				font-size: 22px;
			}
			.rain-map-time-wrapper i {
				margin-right: 6px;
			}
		</style>
	</head>
	<body style="background-color: #fff;">
		<div id="rain-map-wrapper">
			<div id="rain-map-map"></div>
			<div id="rain-map-time-wrapper" class="rain-map-time-wrapper">
				<i id="rain-map-clock" class="fas fa-clock"></i
				><span id="rain-map-time"></span>
			</div>
		</div>
		<script>
			const config2 = {
				animationSpeedMs: 600,
				chromePath: null, // Set to "/usr/bin/chromium-browser" on Raspbian
				chromeTimeout: 0,
				defaultZoomLevel: 5,
				displayClockSymbol: false,
				displayOnRainOnly: false,
				displayTime: true,
				extraDelayLastFrameMs: 2000,
				mapHeightPx: 320,
				mapWidthPx: 320,
				markers: [
					{ lat: 50, lng: 9.27, zoom: 8, color: "red", hidden: false },
					{ lat: 50, lng: 9.27, zoom: 4, color: "red", hidden: true },
				],
				markerChangeInterval: 0,
				rainIcons: ["09d", "09n", "10d", "10n", "11d", "11n", "13d", "13n"],
				overlayOpacity: 0.65,
				timeFormat: 24,
				updateIntervalMs: 120000,
			};
			let map;
			let animationPosition = 0;
			let markerPosition = 0;
			let radarLayers = [];
			let timestamps = [];

			const supportedIconColors = [
				"black",
				"blue",
				"gold",
				"green",
				"grey",
				"orange",
				"red",
				"violet",
				"yellow",
			];

			const postNodeHelperMessage = (notification, data) => {
				if (typeof window.postNodeHelperMessage !== "undefined") {
					window.postNodeHelperMessage({ notification, data });
				} else {
					console.log("postNodeHelperMessage", { notification, data });
				}
			};

			const initMap = () => {
				try {
					// Configure height/width
					document.getElementById(
						"rain-map-map"
					).style.height = `${config.mapHeightPx}px`;
					document.getElementById(
						"rain-map-map"
					).style.width = `${config.mapWidthPx}px`;

					// Configure clock
					if (!config.displayClockSymbol) {
						document.getElementById("rain-map-clock").style.display = "none";
					}
					if (!config.displayTime) {
						document.getElementById("rain-map-time-wrapper").style.display =
							"none";
					}

					// Init Map
					const initialMarker = config.markers[0];
					map = L.map("rain-map-map", {
						zoomControl: false,
						attributionControl: false,
					}).setView(
						[initialMarker.lat, initialMarker.lng],
						initialMarker.zoom || config.defaultZoomLevel
					);

					// Set Markers
					config.markers.forEach((marker) => {
						if (!marker.hidden) {
							const color =
								marker.color && supportedIconColors.includes(marker.color)
									? marker.color
									: "red";
							L.marker([marker.lat, marker.lng], {
								icon: new L.Icon({
									iconUrl: `https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
									shadowUrl:
										"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
									iconSize: [25, 41],
									iconAnchor: [12, 41],
									popupAnchor: [1, -34],
									shadowSize: [41, 41],
								}),
							}).addTo(map);
						}
					});

					// Add general Map Tile layer
					L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png")
						.addTo(map)
						.on("load", () => {
							postNodeHelperMessage("MAP_INIT_SUCCESS");
						});
				} catch (err) {}
			};

			const getTimestamps = async () => {
				radarLayers = [];
				animationPosition = 0;
				await fetch("https://api.rainviewer.com/public/maps.json")
					.then((response) => response.json())
					.then(async (data) => {
						const layers = [];
						timestamps = data;
						for (const ts of timestamps) {
							layers.push(
								new Promise((resolve, reject) => {
									radarLayers[ts] = new L.TileLayer(
										"https://tilecache.rainviewer.com/v2/radar/" +
											ts +
											"/256/{z}/{x}/{y}/2/1_1.png",
										{
											tileSize: 256,
											opacity: 0.001,
											zIndex: ts,
										}
									)
										.addTo(map)
										.on("load", () => {
											resolve();
										});
								})
							);
						}
						await Promise.all(layers).then(() => {
							postNodeHelperMessage("GET_TIMESTAMPS_SUCCESS", data);
						});
					});
			};

			const setViewToCurrentMarkerPosition = () => {
				const currentMarker = config.markers[markerPosition];
				map.setView(
					new L.LatLng(currentMarker.lat, currentMarker.lng),
					currentMarker.zoom || config.defaultZoomLevel,
					{
						animation: false,
					}
				);
			};

			const renderNextFrame = async () => {
				if (!timestamps || timestamps.length === 0) {
					console.log("Get timestamps");
					await getTimestamps();
				} else if (
					timestamps &&
					animationPosition === timestamps.length &&
					markerPosition < config.markers.length
				) {
					console.log("Get timestamps for new marker");
					animationPosition = 0;
					markerPosition++;
					setViewToCurrentMarkerPosition();
					await getTimestamps();
				} else {
					console.log("Timestamps already present");
				}
				for (const ts of timestamps) {
					radarLayers[ts].setOpacity(0);
				}
				const ts = timestamps[animationPosition];
				radarLayers[ts].setOpacity(config.overlayOpacity);

				if (config.displayTime) {
					const time = moment(ts * 1000);
					if (config.timezone) {
						time.tz(config.timezone);
					}
					let hourSymbol = "HH";
					if (config.timeFormat !== 24) {
						hourSymbol = "h";
					}

					document.getElementById("rain-map-time").innerHTML = `${time.format(
						hourSymbol + ":mm"
					)}`;
				}
				let hasMore = false;
				if (
					animationPosition + 1 < timestamps.length ||
					markerPosition + 1 < config.markers.length
				) {
					hasMore = true;
					animationPosition++;
				}
				postNodeHelperMessage("RENDER_FRAME_SUCCESS", {
					markerPosition,
					animationPosition,
					ts,
					hasMore,
				});
			};

			//initMap();
		</script>
	</body>
</html>
